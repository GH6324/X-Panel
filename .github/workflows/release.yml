name: Release X-Panel

on:
  workflow_dispatch:
  release:
    types: [published]
  push:
    branches:
      - main
    paths:
      - '.github/workflows/release.yml'
      - '**.js'
      - '**.css'
      - '**.html'
      - '**.sh'
      - '**.go'
      - 'go.mod'
      - 'go.sum'
      - 'x-ui.service'

jobs:
  # ===============================================================
  # Linux å¹³å°çš„æ„å»ºä»»åŠ¡ (è¿™æ˜¯åŸæœ‰çš„ä»»åŠ¡ï¼Œä¿æŒä¸å˜)
  # ===============================================================
  build-linux:
    name: Build for Linux
    permissions:
      contents: write
    strategy:
      # ã€æ–°å¢ã€‘è®¾ç½®ä¸º falseï¼Œè¿™æ ·æŸä¸ªæ¶æ„å¤±è´¥ä¸ä¼šå¯¼è‡´å…¶ä»–æ¶æ„è¢«å–æ¶ˆ
      fail-fast: false
      matrix:
        platform:
          - amd64
          - arm64
          - armv7
          - armv6
          - 386
          - s390x
          - armv5
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version-file: go.mod
          check-latest: true

      # ===============================================================
      # ã€ä¿®æ”¹ã€‘æ–°å¢æ­¥éª¤ï¼šå®‰è£… garble æ··æ·†å·¥å…·
      # ===============================================================
      - name: Install Garble (Obfuscator)
        run: |
          # ã€”ä¸­æ–‡æ³¨é‡Šã€•: å®‰è£… garble å·¥å…·
          go install mvdan.cc/garble@latest
          # ã€”ä¸­æ–‡æ³¨é‡Šã€•: å°† garble çš„å®‰è£…è·¯å¾„æ·»åŠ åˆ° PATHï¼Œä»¥ç¡®ä¿å®ƒèƒ½åœ¨åç»­æ­¥éª¤ä¸­è¢«è°ƒç”¨
          # éªŒè¯å®‰è£…æ˜¯å¦æˆåŠŸï¼Œå¹¶æ‰“å°è·¯å¾„
          echo "Garble installed at: $(go env GOPATH)/bin/garble"
          $(go env GOPATH)/bin/garble version

      - name: Build X-Panel for Linux
        run: |
          # ===============================================================
          # å¿…é¡»ç»Ÿä¸€è®¾ç½®ä¸º GOARCH=armï¼Œç„¶åé…åˆ GOARM=5/6/7
          # ===============================================================
          
          export CGO_ENABLED=0
          export GOOS=linux
          
          # è·å–çŸ©é˜µä¸­çš„å¹³å°åç§°
          PLATFORM="${{ matrix.platform }}"
          
          # åˆå§‹åŒ–å˜é‡
          export GOARCH="$PLATFORM"
          export GOARM=""

          # é’ˆå¯¹ ARM 32ä½è¿›è¡Œç‰¹æ®Šå¤„ç†
          case "$PLATFORM" in
            armv7)
              export GOARCH=arm
              export GOARM=7
              ;;
            armv6)
              export GOARCH=arm
              export GOARM=6
              ;;
            armv5)
              export GOARCH=arm
              export GOARM=5
              ;;
          esac

          # æ‰“å°ç¯å¢ƒä¿¡æ¯ä»¥ä¾¿è°ƒè¯•
          echo "ğŸš€ Start Building for GOOS=$GOOS GOARCH=$GOARCH GOARM=$GOARM..."
          
          # ===============================================================
          # ã€æ ¸å¿ƒä¿®å¤ã€‘
          # 1. ä½¿ç”¨ $(go env GOPATH)/bin/garble ç¡®ä¿ç»å¯¹è·¯å¾„è°ƒç”¨
          # 2. å°†ç¼–è¯‘ç›®æ ‡ main.go æ”¹ä¸º ./ (ç¼–è¯‘æ•´ä¸ªåŒ…ï¼Œé˜²æ­¢æ¼æ‰åŒçº§æ–‡ä»¶)
          # 3. ç§»é™¤ -tiny ä»¥æé«˜å…¼å®¹æ€§ (å¦‚æœæˆåŠŸäº†ï¼Œä¸‹æ¬¡å¯ä»¥å†åŠ å›å»)
          # 4. æ·»åŠ  -x å‚æ•°ä»¥æ‰“å°è¯¦ç»†æ—¥å¿—ï¼Œæ–¹ä¾¿æ’é”™
          # ===============================================================
          $(go env GOPATH)/bin/garble -tiny build -ldflags "-w -s" -o xui-release -v -x ./


          # éªŒè¯ç”Ÿæˆçš„æ–‡ä»¶
          ls -lh xui-release

          file xui-release
          ldd xui-release || echo "Static binary confirmed"
          
          mkdir x-ui
          cp xui-release x-ui/
          cp x-ui.service x-ui/
          cp x-ui.sh x-ui/
          mv x-ui/xui-release x-ui/x-ui
          mkdir x-ui/bin
          cd x-ui/bin
          
          # Download dependencies
          Xray_URL="https://github.com/XTLS/Xray-core/releases/download/v25.10.15/"
          if [ "${{ matrix.platform }}" == "amd64" ]; then
            wget -q ${Xray_URL}Xray-linux-64.zip
            unzip Xray-linux-64.zip
            rm -f Xray-linux-64.zip
          elif [ "${{ matrix.platform }}" == "arm64" ]; then
            wget -q ${Xray_URL}Xray-linux-arm64-v8a.zip
            unzip Xray-linux-arm64-v8a.zip
            rm -f Xray-linux-arm64-v8a.zip
          elif [ "${{ matrix.platform }}" == "armv7" ]; then
            wget -q ${Xray_URL}Xray-linux-arm32-v7a.zip
            unzip Xray-linux-arm32-v7a.zip
            rm -f Xray-linux-arm32-v7a.zip
          elif [ "${{ matrix.platform }}" == "armv6" ]; then
            wget -q ${Xray_URL}Xray-linux-arm32-v6.zip
            unzip Xray-linux-arm32-v6.zip
            rm -f Xray-linux-arm32-v6.zip
          elif [ "${{ matrix.platform }}" == "386" ]; then
            wget -q ${Xray_URL}Xray-linux-32.zip
            unzip Xray-linux-32.zip
            rm -f Xray-linux-32.zip
          elif [ "${{ matrix.platform }}" == "armv5" ]; then
            wget -q ${Xray_URL}Xray-linux-arm32-v5.zip
            unzip Xray-linux-arm32-v5.zip
            rm -f Xray-linux-arm32-v5.zip
          elif [ "${{ matrix.platform }}" == "s390x" ]; then
            wget -q ${Xray_URL}Xray-linux-s390x.zip
            unzip Xray-linux-s390x.zip
            rm -f Xray-linux-s390x.zip
          fi
          rm -f geoip.dat geosite.dat
          wget -q https://github.com/Loyalsoldier/v2ray-rules-dat/releases/latest/download/geoip.dat
          wget -q https://github.com/Loyalsoldier/v2ray-rules-dat/releases/latest/download/geosite.dat
          wget -q -O geoip_IR.dat https://github.com/chocolate4u/Iran-v2ray-rules/releases/latest/download/geoip.dat
          wget -q -O geosite_IR.dat https://github.com/chocolate4u/Iran-v2ray-rules/releases/latest/download/geosite.dat
          wget -q -O geoip_RU.dat https://github.com/runetfreedom/russia-v2ray-rules-dat/releases/latest/download/geoip.dat
          wget -q -O geosite_RU.dat https://github.com/runetfreedom/russia-v2ray-rules-dat/releases/latest/download/geosite.dat
          mv xray xray-linux-${{ matrix.platform }}
          cd ../..

      - name: Package
        run: tar -zcvf x-ui-linux-${{ matrix.platform }}.tar.gz x-ui

      - name: Upload files to Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: x-ui-linux-${{ matrix.platform }}
          path: ./x-ui-linux-${{ matrix.platform }}.tar.gz
          retention-days: 1   # <--- å¼ºåˆ¶åªä¿ç•™1å¤©

      - name: Upload files to GH release
        uses: svenstaro/upload-release-action@v2
        if: github.event_name == 'release' && github.event.action == 'published'
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          tag: ${{ github.ref }}
          file: x-ui-linux-${{ matrix.platform }}.tar.gz
          asset_name: x-ui-linux-${{ matrix.platform }}.tar.gz
          # å¦‚æœè¿™æ˜¯é¢„å‘å¸ƒç‰ˆæœ¬ï¼Œå¯ä»¥æ­¤è¡Œæ³¨é‡Š
          prerelease: true  

  # ===============================================================
  # ã€æ–°å¢ã€‘Windows å¹³å°çš„æ„å»ºä»»åŠ¡
  # ===============================================================
  build-windows:
    name: Build for Windows
    permissions:
      contents: write
    strategy:
      matrix:
        # ã€”ä¸­æ–‡æ³¨é‡Šã€•: å®šä¹‰éœ€è¦æ„å»ºçš„ Windows CPU æ¶æ„ï¼Œä¸€èˆ¬ amd64 å°±å¤Ÿäº†
        platform:
          - amd64
          - 386
    # ã€”ä¸­æ–‡æ³¨é‡Šã€•: æŒ‡å®šä½¿ç”¨ Windows æœ€æ–°ç‰ˆçš„è™šæ‹Ÿç¯å¢ƒ
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version-file: go.mod
          check-latest: true

      # ===============================================================
      # ã€ä¿®æ”¹ã€‘æ–°å¢æ­¥éª¤ï¼šå®‰è£… garble æ··æ·†å·¥å…· (Windows)
      # ===============================================================
      - name: Install Garble (Obfuscator)
        shell: pwsh
        run: |
          # ã€”ä¸­æ–‡æ³¨é‡Šã€•: å®‰è£… garble å·¥å…·
          go install mvdan.cc/garble@latest
          # ã€”ä¸­æ–‡æ³¨é‡Šã€•: å°† garble çš„å®‰è£…è·¯å¾„æ·»åŠ åˆ° PATHï¼Œä»¥ç¡®ä¿å®ƒèƒ½åœ¨åç»­æ­¥éª¤ä¸­è¢«è°ƒç”¨
          $env:PATH += ";$(go env GOPATH)\bin"

      - name: Build X-Panel for Windows
        # ã€”ä¸­æ–‡æ³¨é‡Šã€•: ä½¿ç”¨ PowerShell æ‰§è¡Œè„šæœ¬ï¼Œæ›´ç¬¦åˆ Windows ç¯å¢ƒ
        shell: pwsh
        run: |
          # ã€”ä¸­æ–‡æ³¨é‡Šã€•: è®¾ç½®ç¯å¢ƒå˜é‡ï¼ŒGOOS=windows æŒ‡å®šç¼–è¯‘ç›®æ ‡ä¸º Windows
          $env:GOOS = "windows"
          $env:GOARCH = "${{ matrix.platform }}"
          # ã€”ä¸­æ–‡æ³¨é‡Šã€•: CGO åœ¨ Windows ä¸‹é€šå¸¸ä¸éœ€è¦ï¼Œè®¾ç½®ä¸º 0
          $env:CGO_ENABLED = "0"

          # ===============================================================
          # ã€ä¿®æ”¹ã€‘ä½¿ç”¨ garble è¿›è¡Œæ··æ·†ç¼–è¯‘
          # 1. garble é»˜è®¤å®‰è£…åœ¨ go/bin ä¸‹ï¼Œactions/setup-go ä¼šå°†å…¶åŠ å…¥ PATHï¼Œå¯ç›´æ¥è°ƒç”¨
          # 2. ä½¿ç”¨ -tiny å‚æ•°å¢å¼ºæ··æ·†
          # ===============================================================
          garble -tiny build -ldflags "-w -s" -o x-ui-release.exe -v main.go

          # ã€”ä¸­æ–‡æ³¨é‡Šã€•: åˆ›å»ºç”¨äºæ‰“åŒ…çš„æ–‡ä»¶å¤¹
          mkdir x-ui
          
          # ã€”ä¸­æ–‡æ³¨é‡Šã€•: ç§»åŠ¨ç¼–è¯‘å¥½çš„ä¸»ç¨‹åºåˆ°æ–‡ä»¶å¤¹ï¼Œå¹¶é‡å‘½åä¸º x-ui.exe
          Move-Item -Path .\x-ui-release.exe -Destination .\x-ui\x-ui.exe

          # ã€”ä¸­æ–‡æ³¨é‡Šã€•: åˆ›å»º bin ç›®å½•å­˜æ”¾ä¾èµ–æ–‡ä»¶
          mkdir x-ui\bin
          cd x-ui\bin
          
          # ã€”ä¸­æ–‡æ³¨é‡Šã€•: ä¸‹è½½ Windows ç‰ˆæœ¬çš„ Xray-core ä¾èµ–
          # æ³¨æ„ï¼šè¿™é‡Œçš„ Xray ç‰ˆæœ¬å· (v25.10.15) æ²¿ç”¨ Linux è„šæœ¬ä¸­çš„ç‰ˆæœ¬
          $Xray_URL="https://github.com/XTLS/Xray-core/releases/download/v25.10.15/"
          if ("${{ matrix.platform }}" -eq "amd64") {
            # Invoke-WebRequest æ˜¯ PowerShell çš„ä¸‹è½½å‘½ä»¤ï¼Œç­‰åŒäº wget
            Invoke-WebRequest -Uri "${Xray_URL}Xray-windows-64.zip" -OutFile "xray.zip"
          } elseif ("${{ matrix.platform }}" -eq "386") {
            Invoke-WebRequest -Uri "${Xray_URL}Xray-windows-32.zip" -OutFile "xray.zip"
          }
          
          # ã€”ä¸­æ–‡æ³¨é‡Šã€•: è§£å‹ xray.zip
          Expand-Archive -Path .\xray.zip -DestinationPath .
          # ã€”ä¸­æ–‡æ³¨é‡Šã€•: åˆ é™¤ä¸‹è½½çš„å‹ç¼©åŒ…
          Remove-Item -Path .\xray.zip

          # ã€”ä¸­æ–‡æ³¨é‡Šã€•: ä¸‹è½½å…¬ç”¨çš„ geo æ•°æ®æ–‡ä»¶ï¼Œè¿™äº›æ–‡ä»¶ä¸å¹³å°æ— å…³
          Remove-Item -Path "geoip.dat", "geosite.dat" -ErrorAction SilentlyContinue
          Invoke-WebRequest -Uri "https://github.com/Loyalsoldier/v2ray-rules-dat/releases/latest/download/geoip.dat" -OutFile "geoip.dat"
          Invoke-WebRequest -Uri "https://github.com/Loyalsoldier/v2ray-rules-dat/releases/latest/download/geosite.dat" -OutFile "geosite.dat"
          Invoke-WebRequest -Uri "https://github.com/chocolate4u/Iran-v2ray-rules/releases/latest/download/geoip.dat" -OutFile "geoip_IR.dat"
          Invoke-WebRequest -Uri "https://github.com/chocolate4u/Iran-v2ray-rules/releases/latest/download/geosite.dat" -OutFile "geosite_IR.dat"
          Invoke-WebRequest -Uri "https://github.com/runetfreedom/russia-v2ray-rules-dat/releases/latest/download/geoip.dat" -OutFile "geoip_RU.dat"
          Invoke-WebRequest -Uri "https://github.com/runetfreedom/russia-v2ray-rules-dat/releases/latest/download/geosite.dat" -OutFile "geosite_RU.dat"
          
          # ã€”ä¸­æ–‡æ³¨é‡Šã€•: å°†è§£å‹å‡ºçš„ xray.exe é‡å‘½åï¼Œä»¥ä¾¿åŒºåˆ†
          Move-Item -Path .\xray.exe -Destination "xray-windows-${{ matrix.platform }}.exe"

          # ã€”ä¸­æ–‡æ³¨é‡Šã€•: è¿”å›åˆ° x-ui æ–‡ä»¶å¤¹çš„æ ¹ç›®å½•
          cd ..
          
          # ===============================================================
          # ã€æ–°å¢éƒ¨åˆ†ã€‘ä»ä»“åº“å¤åˆ¶è¾…åŠ©æ–‡ä»¶åˆ°å¾…æ‰“åŒ…çš„ x-ui ç›®å½•ä¸­
          # è¾…åŠ©æ–‡ä»¶éƒ½æ”¾åœ¨äº†é¡¹ç›®æ ¹ç›®å½•çš„ windows_files æ–‡ä»¶å¤¹ä¸‹
          # ===============================================================
          Copy-Item -Path ..\windows_files\* -Destination . -Recurse

          # ã€”ä¸­æ–‡æ³¨é‡Šã€•: è¿”å›é¡¹ç›®æ ¹ç›®å½•
          cd ..

      - name: Package to Zip
        # ã€”ä¸­æ–‡æ³¨é‡Šã€•: ä½¿ç”¨ PowerShell å‘½ä»¤å°† x-ui æ–‡ä»¶å¤¹æ‰“åŒ…æˆ zip å‹ç¼©åŒ…
        shell: pwsh
        run: |
          Compress-Archive -Path .\x-ui -DestinationPath "x-ui-windows-${{ matrix.platform }}.zip"

      - name: Upload files to Artifacts
        uses: actions/upload-artifact@v4
        with:
          # ã€”ä¸­æ–‡æ³¨é‡Šã€•: ä¸Šä¼ çš„æ„å»ºäº§ç‰©åç§°ï¼Œæ˜ç¡®æ ‡è¯†ä¸º windows
          name: x-ui-windows-${{ matrix.platform }}
          # ã€”ä¸­æ–‡æ³¨é‡Šã€•: ä¸Šä¼ çš„å‹ç¼©åŒ…è·¯å¾„
          path: ./x-ui-windows-${{ matrix.platform }}.zip
          retention-days: 1   # <--- å¼ºåˆ¶åªä¿ç•™1å¤©

      - name: Upload files to GH release
        uses: svenstaro/upload-release-action@v2
        if: github.event_name == 'release' && github.event.action == 'published'
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          tag: ${{ github.ref }}
          # ã€”ä¸­æ–‡æ³¨é‡Šã€•: æŒ‡å®šè¦ä¸Šä¼ çš„æ–‡ä»¶ä¸º windows çš„ zip åŒ…
          file: x-ui-windows-${{ matrix.platform }}.zip
          # ã€”ä¸­æ–‡æ³¨é‡Šã€•: åœ¨ Release é¡µé¢æ˜¾ç¤ºçš„èµ„äº§åç§°
          asset_name: x-ui-windows-${{ matrix.platform }}.zip
          prerelease: true
